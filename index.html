<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Share Dynamic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        #header {
            height: 35px;
            text-align: center;
            padding: 8px 0;
            background: #fff;
            flex-shrink: 0;
        }
        
        h1 { 
            margin: 0; 
            font-size: 14px; 
            color: #333; 
            font-weight: 600; 
        }

        #chart-container {
            flex: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            background: #fff;
        }
        
        #chart-container svg {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        #legend {
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            padding: 8px;
            background: #fff;
            flex-shrink: 0;
        }
        
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            font-size: 10px; 
        }
        
        .legend-color { 
            width: 12px; 
            height: 12px; 
            border-radius: 2px; 
            flex-shrink: 0;
        }
        
        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 9999;
            white-space: nowrap;
        }
        
        .axis text { 
            font-size: 9px; 
            fill: #666; 
        }
        
        .axis line, .axis path { 
            stroke: #ddd; 
        }
        
        .grid line {
            stroke: #f0f0f0;
            stroke-dasharray: 2,2;
        }

        #error-message {
            display: none;
            padding: 20px;
            text-align: center;
            color: #d32f2f;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Market Share por Mes (%)</h1>
    </div>

    <div id="error-message"></div>
    <div id="chart-container"></div>
    <div id="legend"></div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        const defaultData = [
            { mes: 'ENE', SUZUKI: 26, HONDA: 26, YAMAHA: 15, AUTECO: 12, AKT: 8, HERO: 7, SYM: 6 },
            { mes: 'FEB', SUZUKI: 26, HONDA: 23, YAMAHA: 17, AUTECO: 13, AKT: 9, HERO: 6, SYM: 6 },
            { mes: 'MAR', SUZUKI: 23, HONDA: 27, YAMAHA: 16, AUTECO: 12, AKT: 9, HERO: 7, SYM: 6 },
            { mes: 'ABR', SUZUKI: 23, HONDA: 27, YAMAHA: 16, AUTECO: 13, AKT: 9, HERO: 6, SYM: 6 },
            { mes: 'MAY', SUZUKI: 27, HONDA: 23, YAMAHA: 15, AUTECO: 13, AKT: 10, HERO: 6, SYM: 6 },
            { mes: 'JUN', SUZUKI: 21, HONDA: 27, YAMAHA: 17, AUTECO: 13, AKT: 10, HERO: 6, SYM: 6 },
            { mes: 'JUL', SUZUKI: 25, HONDA: 23, YAMAHA: 16, AUTECO: 13, AKT: 11, HERO: 6, SYM: 6 },
            { mes: 'AGO', SUZUKI: 23, HONDA: 24, YAMAHA: 17, AUTECO: 13, AKT: 11, HERO: 6, SYM: 6 },
            { mes: 'SEP', SUZUKI: 23, HONDA: 24, YAMAHA: 17, AUTECO: 13, AKT: 11, HERO: 6, SYM: 6 },
            { mes: 'OCT', SUZUKI: 24, HONDA: 23, YAMAHA: 17, AUTECO: 14, AKT: 10, HERO: 6, SYM: 6 },
            { mes: 'NOV', SUZUKI: 24, HONDA: 24, YAMAHA: 16, AUTECO: 14, AKT: 10, HERO: 6, SYM: 6 }
        ];

        const defaultColors = {
            'SUZUKI': '#4CAF50',
            'HONDA': '#F44336',
            'YAMAHA': '#2196F3',
            'AUTECO': '#9E9E9E',
            'AKT': '#FF9800',
            'HERO': '#795548',
            'SYM': '#B0BEC5'
        };

        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            const monthsParam = urlParams.get('months');
            if (!monthsParam) return null;

            const months = monthsParam.split(',');
            const data = [];
            const brands = [];

            for (const [key, value] of urlParams.entries()) {
                if (key !== 'months' && key !== 'colors' && key !== 'highlight') {
                    brands.push(key);
                }
            }

            for (let i = 0; i < months.length; i++) {
                const monthData = { mes: months[i].trim() };
                brands.forEach(brand => {
                    const values = urlParams.get(brand).split(',');
                    monthData[brand] = parseFloat(values[i]) || 0;
                });
                data.push(monthData);
            }

            const colorsParam = urlParams.get('colors');
            let colors = { ...defaultColors };
            if (colorsParam) {
                const colorPairs = colorsParam.split('|');
                colorPairs.forEach(pair => {
                    const [brand, color] = pair.split(':');
                    if (brand && color) colors[brand] = color;
                });
            }

            const highlightParam = urlParams.get('highlight');
            const highlight = highlightParam ? highlightParam.toUpperCase() : 'HONDA';

            return { data, brands, colors, highlight };
        }

        let chartData, brands, colors, highlightBrand;

        try {
            const parsed = parseUrlParams();
            if (parsed && parsed.data.length > 0) {
                chartData = parsed.data;
                brands = parsed.brands;
                colors = parsed.colors;
                highlightBrand = parsed.highlight;
            } else {
                chartData = defaultData;
                brands = ['SUZUKI', 'HONDA', 'YAMAHA', 'AUTECO', 'AKT', 'HERO', 'SYM'];
                colors = defaultColors;
                highlightBrand = 'HONDA';
            }
        } catch (error) {
            console.error('Error parsing URL params:', error);
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = 'Error al cargar los datos. Mostrando datos de ejemplo.';
            chartData = defaultData;
            brands = ['SUZUKI', 'HONDA', 'YAMAHA', 'AUTECO', 'AKT', 'HERO', 'SYM'];
            colors = defaultColors;
            highlightBrand = 'HONDA';
        }

        const legendDiv = d3.select("#legend");
        brands.forEach(brand => {
            const item = legendDiv.append("div").attr("class", "legend-item");
            item.append("div").attr("class", "legend-color").style("background-color", colors[brand] || '#999');
            item.append("span").text(brand);
        });

        const container = document.getElementById("chart-container");
        const tooltip = d3.select("#tooltip");

        function draw() {
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            if (containerWidth < 100 || containerHeight < 100) return;

            d3.select("#chart-container").selectAll("*").remove();

            const margin = { 
                top: 10, 
                right: 15, 
                bottom: 20, 
                left: 35 
            };
            
            const width = containerWidth;
            const height = containerHeight;
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#chart-container")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "none")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .domain(chartData.map(d => d.mes))
                .range([0, innerWidth])
                .padding(0.15);

            const y = d3.scaleLinear()
                .domain([0, 100])
                .range([innerHeight, 0]);

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y).tickSize(-innerWidth).tickFormat("").ticks(5))
                .style("opacity", 0.3);

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(x).tickSize(5));

            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y).tickFormat(d => d + "%").ticks(5).tickSize(5));

            const processedData = chartData.map(d => {
                const values = brands.map(brand => ({ brand, value: d[brand] || 0 }));
                values.sort((a, b) => a.value - b.value);
                let cumulative = 0;
                return {
                    mes: d.mes,
                    bands: values.map(v => {
                        const start = cumulative;
                        cumulative += v.value;
                        return { brand: v.brand, value: v.value, y0: start, y1: cumulative };
                    })
                };
            });

            const barWidth = x.bandwidth();

            brands.forEach(brand => {
                for (let i = 0; i < processedData.length - 1; i++) {
                    const current = processedData[i];
                    const next = processedData[i + 1];
                    const cb = current.bands.find(b => b.brand === brand);
                    const nb = next.bands.find(b => b.brand === brand);
                    
                    if (!cb || !nb) continue;

                    const x0 = x(current.mes);
                    const x1 = x(next.mes);
                    const ribbonPath = `
                        M ${x0},${y(cb.y0)}
                        L ${x0 + barWidth},${y(cb.y0)}
                        L ${x0 + barWidth},${y(cb.y1)}
                        L ${x0},${y(cb.y1)}
                        Z
                        M ${x0 + barWidth},${y(cb.y0)}
                        C ${x0 + barWidth + (x1 - x0 - barWidth) / 2},${y(cb.y0)}
                          ${x1 - (x1 - x0 - barWidth) / 2},${y(nb.y0)}
                          ${x1},${y(nb.y0)}
                        L ${x1},${y(nb.y1)}
                        C ${x1 - (x1 - x0 - barWidth) / 2},${y(nb.y1)}
                          ${x0 + barWidth + (x1 - x0 - barWidth) / 2},${y(cb.y1)}
                          ${x0 + barWidth},${y(cb.y1)}
                        Z
                    `;
                    
                    svg.append("path")
                        .attr("d", ribbonPath)
                        .attr("fill", colors[brand] || '#999')
                        .attr("opacity", 0.8)
                        .style("cursor", "pointer")
                        .on("mouseover", function() {
                            d3.select(this).attr("opacity", 1);
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event) {
                            tooltip
                                .html(`<strong>${brand}</strong><br/>${current.mes}: ${cb.value}% â†’ ${next.mes}: ${nb.value}%`)
                                .style("left", (event.clientX + 10) + "px")
                                .style("top", (event.clientY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("opacity", 0.8);
                            tooltip.style("opacity", 0);
                        });
                }

                processedData.forEach(month => {
                    const band = month.bands.find(b => b.brand === brand);
                    if (!band) return;
                    
                    const xPos = x(month.mes);
                    const rectHeight = Math.max(0, y(band.y0) - y(band.y1));
                    
                    svg.append("rect")
                        .attr("x", xPos)
                        .attr("y", y(band.y1))
                        .attr("width", barWidth)
                        .attr("height", rectHeight)
                        .attr("fill", colors[brand] || '#999')
                        .attr("opacity", 0.8)
                        .style("cursor", "pointer")
                        .on("mouseover", function() {
                            d3.select(this).attr("opacity", 1);
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event) {
                            tooltip
                                .html(`<strong>${brand}</strong><br/>${month.mes}: ${band.value}%`)
                                .style("left", (event.clientX + 10) + "px")
                                .style("top", (event.clientY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("opacity", 0.8);
                            tooltip.style("opacity", 0);
                        });

                    if (brand === highlightBrand && barWidth > 15 && rectHeight > 12) {
                        svg.append("text")
                            .attr("x", xPos + barWidth / 2)
                            .attr("y", y(band.y1) - 3)
                            .attr("text-anchor", "middle")
                            .attr("fill", colors[brand] || '#999')
                            .attr("font-weight", "bold")
                            .attr("font-size", "9px")
                            .text(band.value + "%");
                    }
                });
            });
        }

        let resizeTimeout;
        function handleResize() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(draw, 50);
        }

        const resizeObserver = new ResizeObserver(handleResize);
        resizeObserver.observe(container);

        window.addEventListener('load', draw);
        window.addEventListener('resize', handleResize);
        
        setTimeout(draw, 100);
    </script>
</body>
</html>
