<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Share Responsive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
        }

        #header {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 0;
            background: #fff;
        }
        h1 { margin: 0; font-size: 14px; color: #333; font-weight: 600; }

        #chart-container {
            flex: 1;
            width: 100%;
            position: relative;
            min-height: 0;
            overflow: hidden;
        }

        #legend {
            flex: 0 0 auto;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            padding: 10px;
            background: #fff;
        }
        
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 11px; 
        }
        .legend-color { 
            width: 14px; 
            height: 14px; 
            border-radius: 2px; 
        }
        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 9999;
        }
        .axis text { 
            font-size: 10px; 
            fill: #666; 
        }
        .axis line, .axis path { 
            stroke: #ddd; 
        }
        .grid line {
            stroke: #f0f0f0;
            stroke-dasharray: 2,2;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Market Share por Mes (%)</h1>
    </div>

    <div id="chart-container"></div>

    <div id="legend"></div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        const data = [
            { mes: 'ENE', SUZUKI: 26, HONDA: 26, YAMAHA: 15, AUTECO: 12, AKT: 8, HERO: 7, SYM: 6 },
            { mes: 'FEB', SUZUKI: 26, HONDA: 23, YAMAHA: 17, AUTECO: 13, AKT: 9, HERO: 6, SYM: 6 },
            { mes: 'MAR', SUZUKI: 23, HONDA: 27, YAMAHA: 16, AUTECO: 12, AKT: 9, HERO: 7, SYM: 6 },
            { mes: 'ABR', SUZUKI: 23, HONDA: 27, YAMAHA: 16, AUTECO: 13, AKT: 9, HERO: 6, SYM: 6 },
            { mes: 'MAY', SUZUKI: 27, HONDA: 23, YAMAHA: 15, AUTECO: 13, AKT: 10, HERO: 6, SYM: 6 },
            { mes: 'JUN', SUZUKI: 21, HONDA: 27, YAMAHA: 17, AUTECO: 13, AKT: 10, HERO: 6, SYM: 6 },
            { mes: 'JUL', SUZUKI: 25, HONDA: 23, YAMAHA: 16, AUTECO: 13, AKT: 11, HERO: 6, SYM: 6 },
            { mes: 'AGO', SUZUKI: 23, HONDA: 24, YAMAHA: 17, AUTECO: 13, AKT: 11, HERO: 6, SYM: 6 },
            { mes: 'SEP', SUZUKI: 23, HONDA: 24, YAMAHA: 17, AUTECO: 13, AKT: 11, HERO: 6, SYM: 6 },
            { mes: 'OCT', SUZUKI: 24, HONDA: 23, YAMAHA: 17, AUTECO: 14, AKT: 10, HERO: 6, SYM: 6 },
            { mes: 'NOV', SUZUKI: 24, HONDA: 24, YAMAHA: 16, AUTECO: 14, AKT: 10, HERO: 6, SYM: 6 }
        ];

        const brands = ['SUZUKI', 'HONDA', 'YAMAHA', 'AUTECO', 'AKT', 'HERO', 'SYM'];
        const colors = {
            'SUZUKI': '#4CAF50',
            'HONDA': '#F44336',
            'YAMAHA': '#2196F3',
            'AUTECO': '#9E9E9E',
            'AKT': '#FF9800',
            'HERO': '#795548',
            'SYM': '#B0BEC5'
        };

        const legendDiv = d3.select("#legend");
        brands.forEach(brand => {
            const item = legendDiv.append("div").attr("class", "legend-item");
            item.append("div").attr("class", "legend-color").style("background-color", colors[brand]);
            item.append("span").text(brand);
        });

        const container = document.getElementById("chart-container");
        const tooltip = d3.select("#tooltip");

        function draw() {
            d3.select("#chart-container").selectAll("svg").remove();

            const rect = container.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            if (width < 50 || height < 50) return;

            const margin = { top: 10, right: 20, bottom: 25, left: 40 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#chart-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .domain(data.map(d => d.mes))
                .range([0, innerWidth])
                .padding(0.2);

            const y = d3.scaleLinear()
                .domain([0, 100])
                .range([innerHeight, 0]);

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y).tickSize(-innerWidth).tickFormat("").ticks(5))
                .style("opacity", 0.3);

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(x));

            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y).tickFormat(d => d + "%").ticks(5));

            const processedData = data.map(d => {
                const values = brands.map(brand => ({ brand, value: d[brand] }));
                values.sort((a, b) => b.value - a.value);
                let cumulative = 0;
                return {
                    mes: d.mes,
                    bands: values.map(v => {
                        const start = cumulative;
                        cumulative += v.value;
                        return { brand: v.brand, value: v.value, y0: start, y1: cumulative };
                    })
                };
            });

            const barWidth = x.bandwidth();

            brands.forEach(brand => {
                for (let i = 0; i < processedData.length - 1; i++) {
                    const current = processedData[i];
                    const next = processedData[i + 1];
                    const cb = current.bands.find(b => b.brand === brand);
                    const nb = next.bands.find(b => b.brand === brand);
                    
                    if (!cb || !nb) continue;

                    const x0 = x(current.mes);
                    const x1 = x(next.mes);
                    const ribbonPath = `
                        M ${x0},${y(cb.y0)}
                        L ${x0 + barWidth},${y(cb.y0)}
                        L ${x0 + barWidth},${y(cb.y1)}
                        L ${x0},${y(cb.y1)}
                        Z
                        M ${x0 + barWidth},${y(cb.y0)}
                        C ${x0 + barWidth + (x1 - x0 - barWidth) / 2},${y(cb.y0)}
                          ${x1 - (x1 - x0 - barWidth) / 2},${y(nb.y0)}
                          ${x1},${y(nb.y0)}
                        L ${x1},${y(nb.y1)}
                        C ${x1 - (x1 - x0 - barWidth) / 2},${y(nb.y1)}
                          ${x0 + barWidth + (x1 - x0 - barWidth) / 2},${y(cb.y1)}
                          ${x0 + barWidth},${y(cb.y1)}
                        Z
                    `;
                    
                    svg.append("path")
                        .attr("d", ribbonPath)
                        .attr("fill", colors[brand])
                        .attr("opacity", 0.8)
                        .on("mouseover", function() {
                            d3.select(this).attr("opacity", 1);
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event) {
                            tooltip
                                .html(`<strong>${brand}</strong><br/>${current.mes}: ${cb.value}% â†’ ${next.mes}: ${nb.value}%`)
                                .style("left", (event.clientX + 10) + "px")
                                .style("top", (event.clientY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("opacity", 0.8);
                            tooltip.style("opacity", 0);
                        });
                }

                processedData.forEach(month => {
                    const band = month.bands.find(b => b.brand === brand);
                    if (!band) return;
                    
                    const xPos = x(month.mes);
                    
                    svg.append("rect")
                        .attr("x", xPos)
                        .attr("y", y(band.y1))
                        .attr("width", barWidth)
                        .attr("height", Math.max(0, y(band.y0) - y(band.y1)))
                        .attr("fill", colors[brand])
                        .attr("opacity", 0.8)
                        .on("mouseover", function() {
                            d3.select(this).attr("opacity", 1);
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event) {
                            tooltip
                                .html(`<strong>${brand}</strong><br/>${month.mes}: ${band.value}%`)
                                .style("left", (event.clientX + 10) + "px")
                                .style("top", (event.clientY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("opacity", 0.8);
                            tooltip.style("opacity", 0);
                        });

                    if (brand === 'HONDA' && barWidth > 20) {
                        svg.append("text")
                            .attr("x", xPos + barWidth / 2)
                            .attr("y", y(band.y1) - 4)
                            .attr("text-anchor", "middle")
                            .attr("fill", colors[brand])
                            .attr("font-weight", "bold")
                            .attr("font-size", "10px")
                            .text(band.value + "%");
                    }
                });
            });
        }

        const resizeObserver = new ResizeObserver(() => {
            draw();
        });

        resizeObserver.observe(container);

        window.addEventListener('load', draw);
        window.addEventListener('resize', draw);
    </script>
</body>
</html>
